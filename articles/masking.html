<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="webmorphR">
<title>Templates and Masking • webmorphR</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.1.0/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.1.0/bootstrap.bundle.min.js"></script><link href="../deps/_Nunito-0.4.1/font.css" rel="stylesheet">
<!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.rawgit.com/afeld/bootstrap-toc/v1.0.1/dist/bootstrap-toc.min.js"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><link href="../extra.css" rel="stylesheet">
<meta property="og:title" content="Templates and Masking">
<meta property="og:description" content="webmorphR">
<meta property="og:image" content="https://debruine.github.io/webmorphR/articles/images/masking/masking.png">
<meta property="og:image:alt" content="webmorphR logo: a blue hexagon with a simplified white wireframe face">
<meta name="twitter:card" content="summary">
<meta name="twitter:creator" content="@lisadebruine">
<meta name="twitter:site" content="@webmorph_org">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-dark navbar-expand-lg bg-primary"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">webmorphR</a>

    <small class="nav-text text-danger me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Unreleased version">0.0.2.9004</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../articles/webmorphR.html">Get started</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/stimuli.html">Making Stimuli</a>
    <a class="dropdown-item" href="../articles/manip.html">Image Manipulations</a>
    <a class="dropdown-item" href="../articles/masking.html">Templates and Masking</a>
    <a class="dropdown-item" href="../articles/figures.html">Making Figures</a>
    <a class="dropdown-item" href="../articles/similarity.html">Image Similarity</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://twitter.com/webmorph_org" aria-label="Twitter">
    <span class="fa fa-twitter"></span>
     
  </a>
</li>
<li class="nav-item">
  <a class="external-link nav-link" href="https://figshare.com/search?q=webmorph%20psychomorph" aria-label="Figshare">
    <span class="ai ai-figshare"></span>
     
  </a>
</li>
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/debruine/webmorphR/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Templates and Masking</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/debruine/webmorphR/blob/HEAD/vignettes/masking.Rmd" class="external-link"><code>vignettes/masking.Rmd</code></a></small>
      <div class="d-none name"><code>masking.Rmd</code></div>
    </div>

    
    
<p>This vignette explains templates and shows you how to mask images
relative to their delineation.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># load packages and set maximum plot width</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://debruine.github.io/webmorphR">webmorphR</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">webmorphR.stim</span><span class="op">)</span> <span class="co"># for extra stimulus sets</span>
<span class="fu"><a href="../reference/wm_opts.html">wm_opts</a></span><span class="op">(</span>plot.maxwidth <span class="op">=</span> <span class="fl">850</span><span class="op">)</span>

<span class="co"># load the demo stimuli</span>
<span class="va">stimuli</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/demo_stim.html">demo_stim</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<div class="section level2">
<h2 id="delineations">Delineations<a class="anchor" aria-label="anchor" href="#delineations"></a>
</h2>
<p>A delineation is a description of the shape of the face using points
connected by lines. The points are describe by their index and x and y
coordinates. The upper left corner is the 0 origin, so the y-coordinates
may go the opposite direction to what you expect.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># the first 6 points</span>
<span class="va">stimuli</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">points</span><span class="op">[</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">6</span><span class="op">]</span>
<span class="co">#&gt;       [,1]     [,2]     [,3]     [,4]     [,5]     [,6]</span>
<span class="co">#&gt; x 210.7407 288.1482 210.6481 204.6296 203.3333 205.2778</span>
<span class="co">#&gt; y 226.4815 226.3889 221.6667 223.3333 226.8519 231.4815</span></code></pre></div>
<p>There is a function so you can get selected point coordinates for a
whole stimulus list.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/get_point.html">get_point</a></span><span class="op">(</span><span class="va">stimuli</span>, <span class="fl">0</span><span class="op">:</span><span class="fl">2</span><span class="op">)</span>
<span class="co">#&gt;     image point        x        y</span>
<span class="co">#&gt; 1 f_multi     0 210.7407 226.4815</span>
<span class="co">#&gt; 2 f_multi     1 288.1482 226.3889</span>
<span class="co">#&gt; 3 f_multi     2 210.6481 221.6667</span>
<span class="co">#&gt; 4 m_multi     0 211.1111 214.4444</span>
<span class="co">#&gt; 5 m_multi     1 286.4815 215.5556</span>
<span class="co">#&gt; 6 m_multi     2 210.9259 210.2778</span></code></pre></div>
<p>The lines are a list of vectors. Each vector contains the line’s
point indices, but 0-based (yes, I know this is annoying, but
psychomorph was developed in Java and all existing template files index
the points starting with 0).</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># the first 6 lines</span>
<span class="va">stimuli</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">lines</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">6</span><span class="op">]</span> |&gt; <span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="op">)</span>
<span class="co">#&gt; List of 6</span>
<span class="co">#&gt;  $ : int [1:2] 0 0</span>
<span class="co">#&gt;  $ : int [1:2] 1 1</span>
<span class="co">#&gt;  $ : int [1:9] 2 3 4 5 6 7 8 9 2</span>
<span class="co">#&gt;  $ : int [1:9] 10 11 12 13 14 15 16 17 10</span>
<span class="co">#&gt;  $ : int [1:5] 18 19 20 21 22</span>
<span class="co">#&gt;  $ : int [1:5] 23 24 25 26 27</span></code></pre></div>
<p>NB: Currently, I’m assuming any lines that start and end with the
same point are closed shapes, so you can’t make tear-drop shapes without
doubling the end coordinate. I might change this someday, so there is
also a vector for flagging whether shapes are closed; this is currently
always FALSE.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">stimuli</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">closed</span>
<span class="co">#&gt;  [1] FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE</span>
<span class="co">#&gt; [13] FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE</span>
<span class="co">#&gt; [25] FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE</span>
<span class="co">#&gt; [37] FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE</span></code></pre></div>
<div class="section level3">
<h3 id="templates">Templates<a class="anchor" aria-label="anchor" href="#templates"></a>
</h3>
<p>Delineations need to follow the same template in order to work
together. For example, you can’t average faces that are delineated with
different templates.</p>
<p>Read in images with webmorph templates, or automatically delineate
images (details below).</p>
<p>WebmorphR uses 5 main templates:</p>
<ul>
<li>FRL: the 1889-point Face Research Lab template that is the default
manual template at <a href="https://webmorph.org" class="external-link">webmorph.org</a>. This
template is also used in the demo stimuli and the Chicago Face Database
delineations.</li>
<li>dlib7: The 7-point internal automatic face detection. This algorithm
requires a python installation, so is a little harder to set up, but
doesn’t send your images to an external company. This is actually a
5-point template (corners of the eyes and tip of the nose), but I added
the centre points of the corners of the eyes as point 0 and 1 for
consistency with all of the other templates. The “pupil” points don’t
always line up with the pupils, as they’re just calculated from the
corners.</li>
<li>dlib70: The 70-point internal automatic face detection. The files
for this are quite large, so you will be prompted to download them the
first time you try to use this delineation.</li>
<li>fpp106: The 106-point Face++ template. This is a high-quality and
detailed template, but requires you to set up your own API key with <a href="https://www.faceplusplus.com/" class="external-link">Face++</a> and will transfer your
images to Face++, so make sure you understand the privacy consequences
of this.</li>
<li>fpp83: The 83-point Face++ template. This is an old template, but I
keep it for consistency with the old auto-delineation template on <a href="https://webmorph.org" class="external-link">webmorph.org</a>.</li>
</ul>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">s</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/webmorphR.stim/man/load_stim.html" class="external-link">load_stim_london</a></span><span class="op">(</span><span class="st">"030"</span><span class="op">)</span>
<span class="va">dlib7</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/auto_delin.html">auto_delin</a></span><span class="op">(</span><span class="va">s</span>, <span class="st">"dlib7"</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="va">dlib70</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/auto_delin.html">auto_delin</a></span><span class="op">(</span><span class="va">s</span>, <span class="st">"dlib70"</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="va">fpp106</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/auto_delin.html">auto_delin</a></span><span class="op">(</span><span class="va">s</span>, <span class="st">"fpp106"</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="va">fpp83</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/auto_delin.html">auto_delin</a></span><span class="op">(</span><span class="va">s</span>, <span class="st">"fpp83"</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">s</span>, <span class="va">dlib7</span>, <span class="va">dlib70</span>, <span class="va">fpp106</span>, <span class="va">fpp83</span><span class="op">)</span> |&gt;
  <span class="fu"><a href="../reference/rename_stim.html">rename_stim</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"frl"</span>, <span class="st">"dlib7"</span>, <span class="st">"dlib70"</span>, <span class="st">"fpp106"</span>, <span class="st">"fpp83"</span><span class="op">)</span><span class="op">)</span> |&gt;
  <span class="fu"><a href="../reference/draw_tem.html">draw_tem</a></span><span class="op">(</span><span class="op">)</span> |&gt;
  <span class="fu"><a href="../reference/crop_tem.html">crop_tem</a></span><span class="op">(</span><span class="fl">50</span><span class="op">)</span> |&gt;
  <span class="fu"><a href="../reference/pad.html">pad</a></span><span class="op">(</span><span class="fl">.15</span>, <span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span> |&gt;
  <span class="fu"><a href="../reference/gglabel.html">gglabel</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">20</span><span class="op">)</span> |&gt;
  <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<p><img src="images/masking/unnamed-chunk-7-1.png" width="100%"></p>
<p>The “smiling” demo dataset doesn’t have FRL templates yet (it will
soon), but can demonstrate how the automatic delineation algorithms deal
with open mouths.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">smile</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/webmorphR.stim/man/load_stim.html" class="external-link">load_stim_smiling</a></span><span class="op">(</span><span class="st">"030"</span><span class="op">)</span>
<span class="va">dlib7s</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/auto_delin.html">auto_delin</a></span><span class="op">(</span><span class="va">smile</span>, <span class="st">"dlib7"</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="va">dlib70s</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/auto_delin.html">auto_delin</a></span><span class="op">(</span><span class="va">smile</span>, <span class="st">"dlib70"</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="va">fpp106s</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/auto_delin.html">auto_delin</a></span><span class="op">(</span><span class="va">smile</span>, <span class="st">"fpp106"</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="va">fpp83s</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/auto_delin.html">auto_delin</a></span><span class="op">(</span><span class="va">smile</span>, <span class="st">"fpp83"</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">dlib7s</span>, <span class="va">dlib70s</span>, <span class="va">fpp106s</span>, <span class="va">fpp83s</span><span class="op">)</span> |&gt;
  <span class="fu"><a href="../reference/rename_stim.html">rename_stim</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"dlib7"</span>, <span class="st">"dlib70"</span>, <span class="st">"fpp106"</span>, <span class="st">"fpp83"</span><span class="op">)</span><span class="op">)</span> |&gt;
  <span class="fu"><a href="../reference/draw_tem.html">draw_tem</a></span><span class="op">(</span><span class="op">)</span> |&gt;
  <span class="fu"><a href="../reference/crop_tem.html">crop_tem</a></span><span class="op">(</span><span class="fl">50</span><span class="op">)</span> |&gt;
  <span class="fu"><a href="../reference/pad.html">pad</a></span><span class="op">(</span><span class="fl">.15</span>, <span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span> |&gt;
  <span class="fu"><a href="../reference/gglabel.html">gglabel</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">20</span><span class="op">)</span> |&gt;
  <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<p><img src="images/masking/unnamed-chunk-9-1.png" width="100%"></p>
</div>
<div class="section level3">
<h3 id="automatic-delineation">Automatic Delineation<a class="anchor" aria-label="anchor" href="#automatic-delineation"></a>
</h3>
<p>If your images aren’t delineated, you can use the
<code><a href="../reference/auto_delin.html">auto_delin()</a></code> function or upload them to <a href="webmorph.org">webmorph</a> to use the extensive manual delineation
functions there and the 189-point FRL template.</p>
<p>The auto-delineation has three options.</p>
<div class="section level4">
<h4 id="dlib">dlib<a class="anchor" aria-label="anchor" href="#dlib"></a>
</h4>
<p>You can use the face recognition algorithms from <a href="http://dlib.net/" class="external-link">dlib</a> to delineate faces on your computer
without transferring them to a third-party service. These files are big
(~100MB) and it’s tricky to include on CRAN, so you can download them
from github. I’ll be training more templates to include in this package
soon.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">remotes</span><span class="fu">::</span><span class="fu"><a href="https://remotes.r-lib.org/reference/install_github.html" class="external-link">install_github</a></span><span class="op">(</span><span class="st">"debruine/webmorphR.dlib"</span><span class="op">)</span></code></pre></div>
<p>This also requires <a href="https://rstudio.github.io/reticulate/" class="external-link">reticulate</a>, python and
the installation of a few packages, and can be tricky.</p>
<p>Many of my issues were solved by setting up a <a href="https://rstudio.github.io/reticulate/" class="external-link">virtual environment</a> for
webmorph, <a href="https://stackoverflow.com/questions/54719496/how-to-install-dlib-for-python-on-mac" class="external-link">installing
dlib</a>, and then setting RETICULATE_PYTHON in my .Revniron using
<code><a href="https://usethis.r-lib.org/reference/edit.html" class="external-link">usethis::edit_r_environ()</a></code>.</p>
<!-- what other python installs? pandas, numpy, scipy -->
<pre><code><span class="va">RETICULATE_PYTHON</span><span class="op">=</span><span class="st">"~/.virtualenvs/webmorph/bin/python"</span></code></pre>
<p>The default is “dlib7”, which is a 7-point template (tip of the nose,
corners of the eyes, and their midpoints) and works without access to
external services. It uses Davis King’s <a href="https://github.com/davisking/dlib-models#shape_predictor_5_face_landmarksdatbz2" class="external-link">shape_predictor_5_face_landmarks.dat</a>.</p>
<p>A better (but slower) option is “dlib70”, a 70-point template (68
plus 2 added centre eye points) from Davis King’s <a href="https://github.com/davisking/dlib-models#shape_predictor_68_face_landmarksdatbz2" class="external-link">shape_predictor_68_face_landmarks.dat</a>.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">frl</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/demo_stim.html">demo_stim</a></span><span class="op">(</span><span class="st">"test"</span>, <span class="st">"m_multi"</span><span class="op">)</span> |&gt; <span class="fu"><a href="../reference/crop.html">crop</a></span><span class="op">(</span><span class="fl">.8</span>, <span class="fl">.8</span><span class="op">)</span>
<span class="va">dlib7</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/auto_delin.html">auto_delin</a></span><span class="op">(</span><span class="va">frl</span>, <span class="st">"dlib7"</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="va">dlib70</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/auto_delin.html">auto_delin</a></span><span class="op">(</span><span class="va">frl</span>, <span class="st">"dlib70"</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></code></pre></div>
<p><img src="images/masking/unnamed-chunk-12-1.png" width="100%"></p>
<p>You can also use your own landmark file by including it with the
argument <code>model_path</code>. Learn more about <a href="https://pyimagesearch.com/2017/04/03/facial-landmarks-dlib-opencv-python/" class="external-link">training
landmark models</a> or search for pre-trained models, such as this <a href="https://github.com/codeniko/shape_predictor_81_face_landmarks" class="external-link">81-point
model</a>. (I don’t think it handles the hairline well, so am working on
training my own model using stimuli more typical to face research.)</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/download.file.html" class="external-link">download.file</a></span><span class="op">(</span><span class="st">"https://github.com/codeniko/shape_predictor_81_face_landmarks/raw/master/shape_predictor_81_face_landmarks.dat"</span>, <span class="st">"dlib81.dat"</span><span class="op">)</span>

<span class="va">dlib_custom</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/auto_delin.html">auto_delin</a></span><span class="op">(</span><span class="va">frl</span>, replace <span class="op">=</span> <span class="cn">TRUE</span>, 
                          model_path <span class="op">=</span> <span class="st">"dlib81.dat"</span><span class="op">)</span>

<span class="va">dlib_custom</span> |&gt; 
  <span class="fu"><a href="../reference/draw_tem.html">draw_tem</a></span><span class="op">(</span>pt.shape <span class="op">=</span> <span class="st">"index"</span>, 
           pt.size <span class="op">=</span> <span class="fl">12</span><span class="op">)</span></code></pre></div>
<p><img src="images/masking/unnamed-chunk-13-1.png" width="100%"></p>
<p>I added the lines and pupil centres to the existing 5-point and
68-point shape landmark files for webmorphR; you can add your own lines
with <code><a href="../reference/change_lines.html">change_lines()</a></code>. Yes, all of the available landmark
files use a bonkers numbering system like this. The lines don’t do much
for image processing, but do help you to visually assess the accuracy of
the delineation.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">dlib_custom_lines</span> <span class="op">&lt;-</span> <span class="va">dlib_custom</span> |&gt;
  <span class="fu"><a href="../reference/change_lines.html">change_lines</a></span><span class="op">(</span>line_id <span class="op">=</span> <span class="st">"face"</span>, pts <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span><span class="op">:</span><span class="fl">16</span>, <span class="fl">78</span>, <span class="fl">74</span>, <span class="fl">79</span>, <span class="fl">73</span>, <span class="fl">72</span>, <span class="fl">80</span>, 
                                         <span class="fl">71</span>, <span class="fl">70</span>, <span class="fl">69</span>, <span class="fl">68</span>, <span class="fl">76</span>, <span class="fl">75</span>, <span class="fl">77</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span> |&gt;
  <span class="fu"><a href="../reference/change_lines.html">change_lines</a></span><span class="op">(</span>line_id <span class="op">=</span> <span class="st">"left_eyebrow"</span>, pts <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">17</span><span class="op">:</span><span class="fl">21</span><span class="op">)</span><span class="op">)</span> |&gt;
  <span class="fu"><a href="../reference/change_lines.html">change_lines</a></span><span class="op">(</span>line_id <span class="op">=</span> <span class="st">"right_eyebrow"</span>, pts <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">22</span><span class="op">:</span><span class="fl">26</span><span class="op">)</span><span class="op">)</span> |&gt;
  <span class="fu"><a href="../reference/change_lines.html">change_lines</a></span><span class="op">(</span>line_id <span class="op">=</span> <span class="st">"top_left_eye"</span>, pts <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">36</span><span class="op">:</span><span class="fl">39</span><span class="op">)</span><span class="op">)</span> |&gt;
  <span class="fu"><a href="../reference/change_lines.html">change_lines</a></span><span class="op">(</span>line_id <span class="op">=</span> <span class="st">"bottom_left_eye"</span>, pts <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">39</span>, <span class="fl">40</span>, <span class="fl">41</span>, <span class="fl">36</span><span class="op">)</span><span class="op">)</span> |&gt;
  <span class="fu"><a href="../reference/change_lines.html">change_lines</a></span><span class="op">(</span>line_id <span class="op">=</span> <span class="st">"top_right_eye"</span>, pts <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">42</span><span class="op">:</span><span class="fl">45</span><span class="op">)</span><span class="op">)</span> |&gt;
  <span class="fu"><a href="../reference/change_lines.html">change_lines</a></span><span class="op">(</span>line_id <span class="op">=</span> <span class="st">"bottom_right_eye"</span>, pts <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">45</span>, <span class="fl">46</span>, <span class="fl">47</span>, <span class="fl">42</span><span class="op">)</span><span class="op">)</span> |&gt;
  <span class="fu"><a href="../reference/change_lines.html">change_lines</a></span><span class="op">(</span>line_id <span class="op">=</span> <span class="st">"nose"</span>, pts <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">27</span><span class="op">:</span><span class="fl">30</span>, <span class="fl">33</span><span class="op">)</span><span class="op">)</span> |&gt;
  <span class="fu"><a href="../reference/change_lines.html">change_lines</a></span><span class="op">(</span>line_id <span class="op">=</span> <span class="st">"under_nose"</span>, pts <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">31</span><span class="op">:</span><span class="fl">35</span><span class="op">)</span><span class="op">)</span> |&gt;
  <span class="fu"><a href="../reference/change_lines.html">change_lines</a></span><span class="op">(</span>line_id <span class="op">=</span> <span class="st">"outer_upper_lip"</span>, pts <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">48</span><span class="op">:</span><span class="fl">54</span><span class="op">)</span><span class="op">)</span> |&gt;
  <span class="fu"><a href="../reference/change_lines.html">change_lines</a></span><span class="op">(</span>line_id <span class="op">=</span> <span class="st">"outer_lower_lip"</span>, pts <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">54</span><span class="op">:</span><span class="fl">59</span>, <span class="fl">48</span><span class="op">)</span><span class="op">)</span> |&gt;
  <span class="fu"><a href="../reference/change_lines.html">change_lines</a></span><span class="op">(</span>line_id <span class="op">=</span> <span class="st">"inner_upper_lip"</span>, pts <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">60</span><span class="op">:</span><span class="fl">64</span><span class="op">)</span><span class="op">)</span> |&gt;
  <span class="fu"><a href="../reference/change_lines.html">change_lines</a></span><span class="op">(</span>line_id <span class="op">=</span> <span class="st">"inner_lower_lip"</span>, pts <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">64</span><span class="op">:</span><span class="fl">67</span>, <span class="fl">60</span><span class="op">)</span><span class="op">)</span>

<span class="va">dlib_custom_lines</span> |&gt;
  <span class="fu"><a href="../reference/draw_tem.html">draw_tem</a></span><span class="op">(</span><span class="op">)</span> |&gt; 
  <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<p><img src="images/masking/unnamed-chunk-14-1.png" width="100%"></p>
</div>
<div class="section level4">
<h4 id="face">Face++<a class="anchor" aria-label="anchor" href="#face"></a>
</h4>
<p>Auto-delineation with web-based software <a href="https://www.faceplusplus.com/" class="external-link">Face++</a> is better, but requires
a free API key from Face++. After signing up for an account, go to <a href="https://console.faceplusplus.com/app/apikey/list" class="external-link uri">https://console.faceplusplus.com/app/apikey/list</a> and
request a free API key. Then add the key and secret to your .Renviron
file.</p>
<p>The function <code><a href="https://usethis.r-lib.org/reference/edit.html" class="external-link">usethis::edit_r_environ()</a></code> will open up your
.Renviron file (you may need to install <code>usethis</code>). Append
the following two lines to it, replacing “1234567890abcdefghijk” with
your personal key and secret. Then you can save and close the file and
restart R to load these into your environment.</p>
<pre><code><span class="va">FACEPLUSPLUS_KEY</span><span class="op">=</span><span class="st">"1234567890abcdefghijk"</span>  
<span class="va">FACEPLUSPLUS_SECRET</span><span class="op">=</span><span class="st">"1234567890abcdefghijk"</span></code></pre>
<p>Now you can access the 106-point (fpp106) and 83-point (fpp83)
templates. Remember, this uploads your images to the Face++ website.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">fpp83</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/auto_delin.html">auto_delin</a></span><span class="op">(</span><span class="va">frl</span>, <span class="st">"fpp83"</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="va">fpp106</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/auto_delin.html">auto_delin</a></span><span class="op">(</span><span class="va">frl</span>, <span class="st">"fpp106"</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></code></pre></div>
<p><img src="images/masking/unnamed-chunk-15-1.png" width="100%"></p>
<p>The 83-point template has a confusing structure and is the only
template where the first two points aren’t the left and right pupil, so
I don’t recommend using it, but it’s available for consistency with the
old method used on <a href="https://webmorph.org" class="external-link">webmorh.org</a>.</p>
<p>The Face++ auto-delineations can handle images with more than one
face. By default, they return the delineation for the first face (I’m
not entirely ure how they decide which is first), but you can set the
face argument to another number if your images have multiple faces.</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># combine two faces into one image with a border</span>
<span class="va">s</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/demo_stim.html">demo_stim</a></span><span class="op">(</span><span class="op">)</span> |&gt; 
  <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span>padding <span class="op">=</span> <span class="fl">0</span><span class="op">)</span> |&gt; 
  <span class="fu"><a href="../reference/pad.html">pad</a></span><span class="op">(</span><span class="fl">20</span>, fill <span class="op">=</span> <span class="st">"dodgerblue"</span><span class="op">)</span>

<span class="co"># get delineations for the first and second face</span>
<span class="va">face1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fpp_auto_delin.html">fpp_auto_delin</a></span><span class="op">(</span><span class="va">s</span>, <span class="st">"fpp106"</span>, <span class="cn">TRUE</span>, <span class="fl">1</span><span class="op">)</span>
<span class="va">face2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fpp_auto_delin.html">fpp_auto_delin</a></span><span class="op">(</span><span class="va">s</span>, <span class="st">"fpp106"</span>, <span class="cn">TRUE</span>, <span class="fl">2</span><span class="op">)</span>

<span class="co"># add template viz and plot</span>
<span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">face1</span>, <span class="va">face2</span><span class="op">)</span> |&gt; <span class="fu"><a href="../reference/draw_tem.html">draw_tem</a></span><span class="op">(</span><span class="op">)</span> |&gt; <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span>nrow <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></code></pre></div>
<p><img src="images/masking/unnamed-chunk-16-1.png" width="100%"></p>
</div>
</div>
<div class="section level3">
<h3 id="manual-delineations">Manual delineations<a class="anchor" aria-label="anchor" href="#manual-delineations"></a>
</h3>
<p>The best way to delineate faces from scratch is through <a href="https://webmorph.org" class="external-link">webmorph.org</a>, but webmorphR has a (very
experimental) shiny app that lets you adjust delineations manually. If
you notice that an auto-delineation isn’t quite right, you can open up
the stimuli using <code><a href="../reference/delin.html">delin()</a></code> and manually adjust it.</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">stimuli</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/demo_stim.html">demo_stim</a></span><span class="op">(</span><span class="op">)</span> |&gt; <span class="fu"><a href="../reference/auto_delin.html">auto_delin</a></span><span class="op">(</span><span class="st">"dlib7"</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="va">manual_delin</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/delin.html">delin</a></span><span class="op">(</span><span class="va">stimuli</span><span class="op">)</span></code></pre></div>
<video controls="controls" width="800" height="618" name="Manual Delineation Shiny App Demo"><source src="images/masking/webmorphR_delin_demo.mov"></source></video>
</div>
<div class="section level3">
<h3 id="visualise-delineations">Visualise delineations<a class="anchor" aria-label="anchor" href="#visualise-delineations"></a>
</h3>
<p>Use the <code><a href="../reference/draw_tem.html">draw_tem()</a></code> function to show the delineations. By
default, points are translucent green circles and lines are translucent
blue.</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">stimuli</span> |&gt;
  <span class="fu"><a href="../reference/draw_tem.html">draw_tem</a></span><span class="op">(</span><span class="op">)</span> |&gt;
  <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<p><img src="images/masking/unnamed-chunk-18-1.png" width="100%"></p>
<p>You can change the default colours and translucency with the
<code>line.color</code> <code>pt.color</code> and
<code>line.alpha</code> and <code>pt.alpha</code> arguments. Change the
point shape with <code>pt.shape</code>. Remove the image and set the
background color with the <code>bg</code> argument.</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">stimuli</span> |&gt;
  <span class="fu"><a href="../reference/draw_tem.html">draw_tem</a></span><span class="op">(</span>line.color <span class="op">=</span> <span class="st">"grey"</span>, line.size <span class="op">=</span> <span class="fl">1</span>, line.alpha <span class="op">=</span> <span class="fl">0.2</span>, 
           pt.color <span class="op">=</span> <span class="st">"red"</span>, pt.size <span class="op">=</span> <span class="fl">5</span>, pt.alpha <span class="op">=</span> <span class="fl">1</span>,
           pt.shape <span class="op">=</span> <span class="st">"cross"</span>, bg <span class="op">=</span> <span class="st">"grey"</span><span class="op">)</span> |&gt;
  <span class="fu"><a href="../reference/crop_tem.html">crop_tem</a></span><span class="op">(</span><span class="fl">20</span><span class="op">)</span> |&gt; <span class="co"># crop with 20px space around the largest tem</span>
  <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<p><img src="images/masking/delin-custom-1.png" width="100%"></p>
</div>
</div>
<div class="section level2">
<h2 id="subset-template">Subset template<a class="anchor" aria-label="anchor" href="#subset-template"></a>
</h2>
<p>It can be useful to subset or change delineation points or lines for
analysis or visualisation.</p>
<div class="section level3">
<h3 id="features">Features<a class="anchor" aria-label="anchor" href="#features"></a>
</h3>
<p>The <code><a href="../reference/features.html">features()</a></code> function returns the points that make up
different subsets of the FRL template (the default manual template for
webmorph.org) or the dlib70 template.</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/features.html">features</a></span><span class="op">(</span><span class="st">"left_eye"</span>, <span class="st">"right_eye"</span><span class="op">)</span>
<span class="co">#&gt;  [1]  0  1  2  3  4  5  6  7  8  9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24</span>
<span class="co">#&gt; [26] 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43</span></code></pre></div>
</div>
<div class="section level3">
<h3 id="subset-template-1">Subset template<a class="anchor" aria-label="anchor" href="#subset-template-1"></a>
</h3>
<p>The “gmm” features are the eyebrows, eyes, nose, and mouth points,
plus the face oval. This is a common subset to use for geometric
morphometric analyses. Use the <code><a href="../reference/subset_tem.html">subset_tem()</a></code> function to
select just those delineation points. The line definitions will be
automatically updated and any lines that no longer have points will be
deleted.</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">stimuli</span> |&gt;
  <span class="fu"><a href="../reference/crop_tem.html">crop_tem</a></span><span class="op">(</span><span class="op">)</span> |&gt;
  <span class="fu"><a href="../reference/subset_tem.html">subset_tem</a></span><span class="op">(</span><span class="fu"><a href="../reference/features.html">features</a></span><span class="op">(</span><span class="st">"gmm"</span><span class="op">)</span><span class="op">)</span> |&gt;
  <span class="fu"><a href="../reference/draw_tem.html">draw_tem</a></span><span class="op">(</span>pt.size <span class="op">=</span> <span class="fl">5</span><span class="op">)</span> |&gt;
  <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<p><img src="images/masking/point-subset-1.png" width="100%"></p>
<p>Make sure to add the <code>tem_id</code> for faces with other
templates, such as the 70-point auto-delineation “dlib70”. You can also
add points manually.</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># add 70-point delineation</span>
<span class="va">stimuli_newdelin</span> <span class="op">&lt;-</span> <span class="va">stimuli</span> |&gt;
  <span class="fu"><a href="../reference/crop_tem.html">crop_tem</a></span><span class="op">(</span><span class="op">)</span> |&gt;
  <span class="fu"><a href="../reference/auto_delin.html">auto_delin</a></span><span class="op">(</span><span class="st">"dlib70"</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>

<span class="va">keep_pts</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span>, <span class="fu"><a href="../reference/features.html">features</a></span><span class="op">(</span><span class="st">"face"</span>, tem_id <span class="op">=</span> <span class="st">"dlib70"</span><span class="op">)</span><span class="op">)</span>

<span class="va">stimuli_newdelin</span> |&gt;
  <span class="fu"><a href="../reference/subset_tem.html">subset_tem</a></span><span class="op">(</span><span class="va">keep_pts</span><span class="op">)</span> |&gt;
  <span class="fu"><a href="../reference/draw_tem.html">draw_tem</a></span><span class="op">(</span>pt.size <span class="op">=</span> <span class="fl">5</span><span class="op">)</span> |&gt;
  <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<p><img src="images/masking/point-remove-1.png" width="100%"></p>
</div>
<div class="section level3">
<h3 id="change-lines">Change lines<a class="anchor" aria-label="anchor" href="#change-lines"></a>
</h3>
<p>When you alter the number of points, the remaining lines don’t always
make sense.</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">s</span> <span class="op">&lt;-</span> <span class="va">stimuli</span> |&gt; <span class="fu"><a href="../reference/subset_tem.html">subset_tem</a></span><span class="op">(</span><span class="fu"><a href="../reference/features.html">features</a></span><span class="op">(</span><span class="st">"face"</span><span class="op">)</span><span class="op">)</span>

<span class="va">s</span> |&gt;
  <span class="fu"><a href="../reference/draw_tem.html">draw_tem</a></span><span class="op">(</span>line.color <span class="op">=</span> <span class="st">"hotpink"</span>, line.alpha <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> |&gt; 
  <span class="fu"><a href="../reference/crop_tem.html">crop_tem</a></span><span class="op">(</span><span class="fl">50</span><span class="op">)</span> |&gt;
  <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<p><img src="images/masking/unnamed-chunk-19-1.png" width="100%"></p>
<p>Notice the extra lines at the ears; they’re the lines that went
around the outside of the ears, and weren’t automatically deleted
because the two points that connect them to the head are still
there.</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">s</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span> |&gt;
  <span class="fu"><a href="../reference/draw_tem.html">draw_tem</a></span><span class="op">(</span>pt.shape <span class="op">=</span> <span class="st">"index"</span>, pt.size <span class="op">=</span> <span class="fl">10</span>,
           line.color <span class="op">=</span> <span class="st">"hotpink"</span>, line.alpha <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> |&gt; 
  <span class="fu"><a href="../reference/crop_tem.html">crop_tem</a></span><span class="op">(</span><span class="fl">50</span><span class="op">)</span> |&gt;
  <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<p><img src="images/masking/unnamed-chunk-20-1.png" width="100%"></p>
<p>Figure out the relevant line numbers from the template. Here, they
are the lines connecting points 0 and 2, and connecting points 3 and 5,
so lines 3 and 4.</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">s</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">lines</span> |&gt; <span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="op">)</span>
<span class="co">#&gt; List of 8</span>
<span class="co">#&gt;  $ : num [1:5] 0 26 1 27 2</span>
<span class="co">#&gt;  $ : num [1:5] 3 28 4 29 5</span>
<span class="co">#&gt;  $ : num [1:2] 0 2</span>
<span class="co">#&gt;  $ : num [1:2] 3 5</span>
<span class="co">#&gt;  $ : num [1:13] 0 15 16 17 18 19 20 21 22 23 ...</span>
<span class="co">#&gt;  $ : num [1:3] 2 6 7</span>
<span class="co">#&gt;  $ : num [1:7] 7 8 9 10 11 12 13</span>
<span class="co">#&gt;  $ : num [1:3] 13 14 5</span></code></pre></div>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">s1</span> <span class="op">&lt;-</span> <span class="va">s</span> |&gt;
  <span class="fu"><a href="../reference/change_lines.html">change_lines</a></span><span class="op">(</span>line_id <span class="op">=</span> <span class="fl">3</span><span class="op">:</span><span class="fl">4</span>, pts <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span>

<span class="va">s1</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span> |&gt;
  <span class="fu"><a href="../reference/draw_tem.html">draw_tem</a></span><span class="op">(</span>pt.shape <span class="op">=</span> <span class="st">"index"</span>, pt.size <span class="op">=</span> <span class="fl">10</span>,
           line.color <span class="op">=</span> <span class="st">"hotpink"</span>, line.alpha <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> |&gt; 
  <span class="fu"><a href="../reference/crop_tem.html">crop_tem</a></span><span class="op">(</span><span class="fl">50</span><span class="op">)</span> |&gt;
  <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<p><img src="images/masking/unnamed-chunk-22-1.png" width="100%"></p>
<p>Alternatively, you can delete all of the lines and start over.</p>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># remove all lines</span>
<span class="va">s2</span> <span class="op">&lt;-</span> <span class="va">s</span> |&gt;
  <span class="fu"><a href="../reference/change_lines.html">change_lines</a></span><span class="op">(</span>line_id <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">8</span>, pts <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span>
<span class="va">s2</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">lines</span>
<span class="co">#&gt; list()</span>

<span class="va">s2</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span> |&gt;
  <span class="fu"><a href="../reference/draw_tem.html">draw_tem</a></span><span class="op">(</span>pt.shape <span class="op">=</span> <span class="st">"index"</span>, pt.size <span class="op">=</span> <span class="fl">10</span><span class="op">)</span> |&gt; 
  <span class="fu"><a href="../reference/crop_tem.html">crop_tem</a></span><span class="op">(</span><span class="fl">50</span><span class="op">)</span> |&gt;
  <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<p><img src="images/masking/unnamed-chunk-23-1.png" width="100%"></p>
<p>The numbering is odd here for historical reasons. The 189-point Face
Research Lab (FRL) template was derived from an earlier 179-point
template from the Perception Lab in St Andrews. The extra points around
the ears, nose, and neck were added then, so they’re out of order. But
there are thousands of faces delineated with this template, so it’s too
late to change.</p>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">face_oval</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">26</span>, <span class="fl">1</span>, <span class="fl">27</span>, <span class="fl">2</span>, <span class="fl">6</span><span class="op">:</span><span class="fl">14</span>, <span class="fl">5</span>, <span class="fl">29</span>, <span class="fl">4</span>, <span class="fl">28</span>, <span class="fl">3</span>, <span class="fl">25</span><span class="op">:</span><span class="fl">15</span>, <span class="fl">0</span><span class="op">)</span>

<span class="va">s3</span> <span class="op">&lt;-</span> <span class="va">s2</span> |&gt;
  <span class="fu"><a href="../reference/change_lines.html">change_lines</a></span><span class="op">(</span>line_id <span class="op">=</span> <span class="fl">1</span>, pts <span class="op">=</span> <span class="va">face_oval</span><span class="op">)</span>

<span class="va">s3</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span> |&gt;
  <span class="fu"><a href="../reference/draw_tem.html">draw_tem</a></span><span class="op">(</span>line.color <span class="op">=</span> <span class="st">"hotpink"</span>, line.alpha <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> |&gt;
  <span class="fu"><a href="../reference/crop_tem.html">crop_tem</a></span><span class="op">(</span><span class="fl">50</span><span class="op">)</span> |&gt;
  <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<p><img src="images/masking/unnamed-chunk-24-1.png" width="100%"></p>
</div>
</div>
<div class="section level2">
<h2 id="masking">Masking<a class="anchor" aria-label="anchor" href="#masking"></a>
</h2>
<div class="section level3">
<h3 id="masking-with-templates">Masking with Templates<a class="anchor" aria-label="anchor" href="#masking-with-templates"></a>
</h3>
<p>If your images are delineated with the FRL template (the default for
example stimuli in webmorph), you can use the built-in masking
features.</p>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># load stimuli with templates</span>
<span class="va">stimuli</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/webmorphR.stim/man/load_stim.html" class="external-link">load_stim_composite</a></span><span class="op">(</span><span class="st">"multi"</span><span class="op">)</span></code></pre></div>
<p>The default mask crops around the face with a white background.</p>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/mask.html">mask</a></span><span class="op">(</span><span class="va">stimuli</span><span class="op">)</span> |&gt; <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<p><img src="images/masking/mask-default-1.png" width="100%"></p>
<p>You can set the mask to any combination of the following: oval, face,
neck, ears (left_ear, right_ear), eyes (left_eye, right_eye), brows
(left_brow, right_brow), mouth, teeth, nose.</p>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/mask.html">mask</a></span><span class="op">(</span><span class="va">stimuli</span>, mask <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"face"</span>, <span class="st">"neck"</span>, <span class="st">"ears"</span><span class="op">)</span>, fill <span class="op">=</span> <span class="st">"dodgerblue"</span><span class="op">)</span> |&gt;
  <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<p><img src="images/masking/mask-combo-1.png" width="100%"></p>
<p>You can reverse the mask. You can also use alpha transparency for the
fill colour.</p>
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/mask.html">mask</a></span><span class="op">(</span><span class="va">stimuli</span>, mask <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"eyes"</span>, <span class="st">"mouth"</span><span class="op">)</span>, 
     fill <span class="op">=</span> <span class="st">"#00000099"</span>, reverse <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> |&gt;
  <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<p><img src="images/masking/mask-reverse-1.png" width="100%"></p>
</div>
<div class="section level3">
<h3 id="oval-mask">Oval Mask<a class="anchor" aria-label="anchor" href="#oval-mask"></a>
</h3>
<p>I hate the “standard oval mask”, which was mainly used because it was
easy, rather than a good idea for face perception. But if you really
want to replicate some stimuli from the 80s…</p>
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">stimuli</span> |&gt;
  <span class="fu"><a href="../reference/greyscale.html">greyscale</a></span><span class="op">(</span><span class="op">)</span> |&gt;
  <span class="fu"><a href="../reference/mask_oval.html">mask_oval</a></span><span class="op">(</span><span class="op">)</span> |&gt;
  <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<p><img src="images/masking/mask-oval-1.png" width="100%"></p>
<p>By default, the oval mask calculates the maximum and minimum x and y
coordinates in the template and masks each face according to this. Set
<code>each = FALSE</code> to calculate this across all images and apply
the same oval to each.</p>
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">stimuli</span> |&gt;
  <span class="fu"><a href="../reference/greyscale.html">greyscale</a></span><span class="op">(</span><span class="op">)</span> |&gt;
  <span class="co"># remove template points to make the oval tighter around the face</span>
  <span class="fu"><a href="../reference/subset_tem.html">subset_tem</a></span><span class="op">(</span><span class="fu"><a href="../reference/features.html">features</a></span><span class="op">(</span><span class="st">"face"</span><span class="op">)</span><span class="op">)</span> |&gt;
  <span class="fu"><a href="../reference/mask_oval.html">mask_oval</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="st">"black"</span>, each <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> |&gt;
  <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<p><img src="images/masking/mask-oval-each-1.png" width="100%"></p>
</div>
<div class="section level3">
<h3 id="subset-templates">Subset templates<a class="anchor" aria-label="anchor" href="#subset-templates"></a>
</h3>
<p>You can subset template points for images delineated with the FRL
template using the convenience function <code><a href="../reference/features.html">features()</a></code>.</p>
<div class="sourceCode" id="cb36"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">full_tem</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/demo_stim.html">demo_stim</a></span><span class="op">(</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>
<span class="va">pts_to_keep</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/features.html">features</a></span><span class="op">(</span><span class="st">"eyes"</span>, <span class="st">"nose"</span>, <span class="st">"mouth"</span>, <span class="st">"brows"</span><span class="op">)</span>
<span class="va">pts_to_delete</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/features.html">features</a></span><span class="op">(</span><span class="st">"cheekbones"</span>, <span class="st">"undereyes"</span>, <span class="st">"smile_lines"</span><span class="op">)</span>

<span class="va">internal_features</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/subset_tem.html">subset_tem</a></span><span class="op">(</span><span class="va">full_tem</span>, <span class="va">pts_to_keep</span><span class="op">)</span>
<span class="va">no_lines</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/subset_tem.html">subset_tem</a></span><span class="op">(</span><span class="va">full_tem</span>, <span class="va">pts_to_delete</span>, keep <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">full_tem</span>, <span class="va">internal_features</span>, <span class="va">no_lines</span><span class="op">)</span> |&gt; 
  <span class="fu"><a href="../reference/draw_tem.html">draw_tem</a></span><span class="op">(</span><span class="op">)</span> |&gt; 
  <span class="fu"><a href="../reference/crop_tem.html">crop_tem</a></span><span class="op">(</span><span class="op">)</span> |&gt;
  <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<p><img src="images/masking/features-demo-1.png" width="100%"></p>
<p>Here are all of the available named features. The feature “gmm” is
the subset of points commonly used for geometric morphometrics, which
excludes points that don’t have clear anatomical definitions.</p>
<div class="sourceCode" id="cb37"><pre class="downlit sourceCode r">
<code class="sourceCode R">
<span class="va">features</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"gmm"</span>, <span class="st">"oval"</span>, <span class="st">"face"</span>, <span class="st">"mouth"</span>, <span class="st">"nose"</span>, <span class="st">"eyes"</span>, <span class="st">"brows"</span>,
              <span class="st">"left_eye"</span>,  <span class="st">"right_eye"</span>, <span class="st">"left_brow"</span>,  <span class="st">"right_brow"</span>,
              <span class="st">"ears"</span>, <span class="st">"undereyes"</span>, <span class="st">"teeth"</span>, <span class="st">"smile_lines"</span>, 
              <span class="st">"cheekbones"</span>, <span class="st">"philtrum"</span>, <span class="st">"chin"</span>, <span class="st">"neck"</span>, <span class="st">"halo"</span><span class="op">)</span>

<span class="co"># crop stimuli to make them easier to see</span>
<span class="va">crops</span> <span class="op">&lt;-</span>  <span class="fu"><a href="../reference/crop_tem.html">crop_tem</a></span><span class="op">(</span><span class="va">full_tem</span><span class="op">)</span>

<span class="co"># plot each feature subset</span>
<span class="va">new_tems</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">features</span>, <span class="kw">function</span><span class="op">(</span><span class="va">ft</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">crops</span> |&gt; 
    <span class="fu"><a href="../reference/subset_tem.html">subset_tem</a></span><span class="op">(</span><span class="fu"><a href="../reference/features.html">features</a></span><span class="op">(</span><span class="va">ft</span><span class="op">)</span><span class="op">)</span> |&gt; 
    <span class="fu"><a href="../reference/draw_tem.html">draw_tem</a></span><span class="op">(</span>pt.color <span class="op">=</span> <span class="st">"#FF0099"</span>,
             pt.size <span class="op">=</span> <span class="fl">8</span>,
             line.color <span class="op">=</span> <span class="st">"#FFFF00"</span>,
             line.size <span class="op">=</span> <span class="fl">5</span>,
             line.alpha <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>
<span class="op">}</span><span class="op">)</span> |&gt; <span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span>what <span class="op">=</span> <span class="va">c</span><span class="op">)</span>

<span class="va">new_tems</span> |&gt; 
  <span class="fu"><a href="../reference/pad.html">pad</a></span><span class="op">(</span><span class="fl">50</span>, <span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">0</span>, fill <span class="op">=</span> <span class="st">"white"</span><span class="op">)</span> |&gt;
  <span class="fu"><a href="../reference/rename_stim.html">rename_stim</a></span><span class="op">(</span><span class="va">features</span><span class="op">)</span> |&gt; 
  <span class="fu"><a href="../reference/label.html">label</a></span><span class="op">(</span><span class="op">)</span> |&gt; 
  <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<p><img src="images/masking/features-all-1.png" width="100%"></p>
</div>
</div>
<div class="section level2">
<h2 id="stimulus-set">Stimulus set<a class="anchor" aria-label="anchor" href="#stimulus-set"></a>
</h2>
<p>Now it’s relatively straightforward to create a stimulus set that
matches old papers.</p>
<div class="sourceCode" id="cb38"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/pkg/webmorphR.stim/man/load_stim.html" class="external-link">load_stim_london</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">)</span> |&gt;
  <span class="fu"><a href="../reference/greyscale.html">greyscale</a></span><span class="op">(</span><span class="op">)</span> |&gt;
  <span class="fu"><a href="../reference/align.html">align</a></span><span class="op">(</span><span class="op">)</span> |&gt;
  <span class="co"># remove template points to make the oval tighter around the face</span>
  <span class="fu"><a href="../reference/subset_tem.html">subset_tem</a></span><span class="op">(</span><span class="fu"><a href="../reference/features.html">features</a></span><span class="op">(</span><span class="st">"face"</span><span class="op">)</span><span class="op">)</span> |&gt;
  <span class="fu"><a href="../reference/mask_oval.html">mask_oval</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="st">"grey"</span><span class="op">)</span> |&gt;
  <span class="fu"><a href="../reference/crop_tem.html">crop_tem</a></span><span class="op">(</span><span class="fl">50</span><span class="op">)</span> |&gt; <span class="co">#  crop to template boundary and add 50px on each side </span>
  <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span>nrow <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></code></pre></div>
<p><img src="images/masking/mask-oval-all-1.png" width="100%"></p>
<p>Although I still think the delineated masking is better :)</p>
<div class="sourceCode" id="cb39"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/pkg/webmorphR.stim/man/load_stim.html" class="external-link">load_stim_london</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">)</span> |&gt;
  <span class="fu"><a href="../reference/resize.html">resize</a></span><span class="op">(</span><span class="fl">0.5</span><span class="op">)</span> |&gt; <span class="co"># resize to process faster</span>
  <span class="fu"><a href="../reference/mask.html">mask</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="st">"grey"</span><span class="op">)</span> |&gt;
  <span class="co"># remove external features before procrustes alignment</span>
  <span class="fu"><a href="../reference/subset_tem.html">subset_tem</a></span><span class="op">(</span><span class="fu"><a href="../reference/features.html">features</a></span><span class="op">(</span><span class="st">"gmm"</span><span class="op">)</span><span class="op">)</span> |&gt;
  <span class="fu"><a href="../reference/align.html">align</a></span><span class="op">(</span>procrustes <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> |&gt;
  <span class="co"># crop to template boundary and add 50px on each side </span>
  <span class="fu"><a href="../reference/crop_tem.html">crop_tem</a></span><span class="op">(</span><span class="fl">50</span><span class="op">)</span> |&gt; 
  <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span>nrow <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></code></pre></div>
<p><img src="images/masking/mask-oval-better-1.png" width="100%"></p>
</div>
<div class="section level2">
<h2 id="custom-masks">Custom Masks<a class="anchor" aria-label="anchor" href="#custom-masks"></a>
</h2>
<p>You can define a custom mask. The code below is useful for finding
the template points you want to outline. It crops around the points,
makes the image darker, makes it larger (so the text is
higher-resolution), and plots it with the point indices.</p>
<div class="sourceCode" id="cb40"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">stimuli</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/webmorphR.stim/man/load_stim.html" class="external-link">load_stim_smiling</a></span><span class="op">(</span><span class="st">"030"</span><span class="op">)</span> |&gt;
  <span class="fu"><a href="../reference/auto_delin.html">auto_delin</a></span><span class="op">(</span><span class="st">"dlib70"</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>

<span class="va">stimuli</span> |&gt; 
  <span class="fu"><a href="../reference/crop_tem.html">crop_tem</a></span><span class="op">(</span><span class="op">)</span> |&gt; 
  <span class="fu"><a href="../reference/resize.html">resize</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span> |&gt;
  <span class="fu"><a href="../reference/draw_tem.html">draw_tem</a></span><span class="op">(</span>pt.size <span class="op">=</span> <span class="fl">35</span>, pt.shape <span class="op">=</span> <span class="st">"circle"</span>, pt.alpha <span class="op">=</span> <span class="fl">1</span>, pt.color <span class="op">=</span> <span class="st">"white"</span><span class="op">)</span> |&gt;
  <span class="fu"><a href="../reference/draw_tem.html">draw_tem</a></span><span class="op">(</span>pt.size <span class="op">=</span> <span class="fl">20</span>, pt.shape <span class="op">=</span> <span class="st">"index"</span>, pt.alpha <span class="op">=</span> <span class="fl">1</span>, pt.color <span class="op">=</span> <span class="st">"black"</span>,
           line.alpha <span class="op">=</span> <span class="fl">0</span><span class="op">)</span> |&gt;
  <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<p><img src="images/masking/unnamed-chunk-26-1.png" width="100%"></p>
<p>Let’s say you wanted to mask the right side of the face and the left
eye. You set up the mask as a list of named areas, and each area is a
list of vectors of the points along each segment of the enclosing
mask.</p>
<div class="sourceCode" id="cb41"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">mask</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>
  right_face <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>
    <span class="fl">10</span><span class="op">:</span><span class="fl">18</span>, <span class="co">#chin to right temple</span>
    <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">18</span>, <span class="fl">28</span><span class="op">:</span><span class="fl">24</span>, <span class="fl">29</span><span class="op">)</span>, <span class="co"># right temple to between eyes</span>
    <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">29</span><span class="op">:</span><span class="fl">32</span>, <span class="fl">35</span>, <span class="fl">53</span>, <span class="fl">64</span>, <span class="fl">68</span>, <span class="fl">59</span>, <span class="fl">10</span><span class="op">)</span> <span class="co"># midline points</span>
  <span class="op">)</span>,
  left_eye <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>
    <span class="fl">38</span><span class="op">:</span><span class="fl">41</span>, <span class="co"># top lid</span>
    <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">41</span><span class="op">:</span><span class="fl">43</span>, <span class="fl">38</span><span class="op">)</span> <span class="co"># bottom lid</span>
  <span class="op">)</span>
<span class="op">)</span>

<span class="fu"><a href="../reference/mask.html">mask</a></span><span class="op">(</span><span class="va">stimuli</span>, <span class="va">mask</span>, fill <span class="op">=</span> <span class="st">"hotpink"</span>, reverse <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> |&gt;
  <span class="fu"><a href="../reference/crop.html">crop</a></span><span class="op">(</span><span class="fl">.6</span>, <span class="fl">.6</span><span class="op">)</span> |&gt;
  <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<p><img src="images/masking/unnamed-chunk-27-1.png" width="100%"></p>
<hr>
<p>This script took 1.1 minutes to render all the included images from
scratch.</p>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Lisa DeBruine.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.3.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
